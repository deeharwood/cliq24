// ===== CLIQ24 DASHBOARD APPLICATION =====

class Cliq24Dashboard {
    constructor() {
        this.apiBaseUrl = window.location.origin;
        this.jwtToken = this.getJWTFromStorage();
        this.socialAccounts = [];
        this.currentUser = null;
        this.allPlatforms = ['Facebook', 'Instagram', 'Twitter', 'LinkedIn', 'TikTok', 'YouTube', 'Snapchat'];
        this.confirmCallback = null;
        this.init();
    }

    // ===== INITIALIZATION =====
    async init() {
        this.setupEventListeners();
        this.addSVGGradient();

        // Check if user is authenticated
        if (!this.jwtToken) {
            this.showLoginPrompt();
            return;
        }

        await this.loadUserData();
        await this.loadSocialAccounts();
        this.startAutoSync();
    }

    // ===== JWT TOKEN MANAGEMENT =====
    getJWTFromStorage() {
        return localStorage.getItem('cliq24_jwt') || sessionStorage.getItem('cliq24_jwt');
    }

    saveJWTToStorage(token) {
        localStorage.setItem('cliq24_jwt', token);
    }

    clearJWTFromStorage() {
        localStorage.removeItem('cliq24_jwt');
        sessionStorage.removeItem('cliq24_jwt');
    }

    // ===== API CALLS =====
    async apiCall(endpoint, options = {}) {
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (this.jwtToken) {
            headers['Authorization'] = `Bearer ${this.jwtToken}`;
        }

        try {
            const response = await fetch(`${this.apiBaseUrl}${endpoint}`, {
                ...options,
                headers
            });

            if (response.status === 401) {
                this.handleUnauthorized();
                return null;
            }

            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }

            return await response.json();
        } catch (error) {
            console.error('API call failed:', error);
            this.showError('Failed to connect to server. Please try again.');
            return null;
        }
    }

    async loadUserData() {
        const user = await this.apiCall('/auth/me');
        if (user) {
            this.currentUser = user;
            this.updateUserUI(user);
        }
    }

    async loadSocialAccounts() {
        const accounts = await this.apiCall('/api/social-accounts');
        if (accounts) {
            this.socialAccounts = accounts;
            this.renderSocialPods();
            this.updateOverallScore();
        } else {
            // Show demo data if no accounts or API fails
            this.loadDemoData();
        }
    }

    async connectSocialAccount(platform) {
        // In a real implementation, this would redirect to OAuth
        // For now, we'll initiate the OAuth flow
        const oauthUrl = `${this.apiBaseUrl}/api/social-accounts/${platform}`;

        if (this.jwtToken) {
            // Redirect to backend OAuth endpoint
            window.location.href = oauthUrl;
        } else {
            // Demo mode - simulate connection
            this.simulatePlatformConnection(platform);
        }
    }

    simulatePlatformConnection(platform) {
        const newAccount = {
            id: `demo-${Date.now()}`,
            platform: platform,
            username: `your${platform.toLowerCase()}`,
            metrics: {
                engagementScore: Math.floor(Math.random() * 40) + 60,
                connections: Math.floor(Math.random() * 50000) + 1000,
                posts: Math.floor(Math.random() * 500) + 50,
                pendingResponses: Math.floor(Math.random() * 50),
                newMessages: Math.floor(Math.random() * 100)
            }
        };

        this.socialAccounts.push(newAccount);
        this.renderSocialPods();
        this.updateOverallScore();
        this.closeModal();
        this.showSuccess(`${platform} connected successfully!`);
    }

    async syncAccount(accountId) {
        const response = await this.apiCall(`/api/social-accounts/${accountId}/sync`, {
            method: 'POST'
        });

        if (response) {
            this.showSuccess('Account synced successfully!');
            await this.loadSocialAccounts();
        } else {
            // Demo mode - simulate sync
            const account = this.socialAccounts.find(a => a.id === accountId);
            if (account) {
                account.metrics.engagementScore = Math.min(100, account.metrics.engagementScore + Math.floor(Math.random() * 5));
                this.renderSocialPods();
                this.updateOverallScore();
                this.showSuccess('Account synced successfully!');
            }
        }
    }

    async deleteAccount(accountId) {
        const response = await this.apiCall(`/api/social-accounts/${accountId}`, {
            method: 'DELETE'
        });

        if (response !== null) {
            this.showSuccess('Account disconnected successfully!');
            await this.loadSocialAccounts();
        } else {
            // Demo mode - remove from array
            this.socialAccounts = this.socialAccounts.filter(a => a.id !== accountId);
            this.renderSocialPods();
            this.updateOverallScore();
            this.showSuccess('Account disconnected successfully!');
        }
    }

    // ===== UI UPDATES =====
    updateUserUI(user) {
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');

        if (userName) {
            userName.textContent = user.name || user.email;
        }

        if (userAvatar) {
            // Use 'picture' field from UserDTO (Google profile picture)
            if (user.picture) {
                userAvatar.style.backgroundImage = `url(${user.picture})`;
                userAvatar.style.backgroundSize = 'cover';
                userAvatar.style.backgroundPosition = 'center';
            }

            // Make avatar clickable to change picture
            userAvatar.style.cursor = 'pointer';
            userAvatar.title = 'Click to change profile picture';
            userAvatar.addEventListener('click', () => this.showProfilePictureDialog());
        }
    }

    renderSocialPods() {
        const grid = document.getElementById('socialPodsGrid');
        if (!grid) return;

        grid.innerHTML = '';

        if (this.socialAccounts.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--text-tertiary);">
                    <p style="font-size: 1.2rem; margin-bottom: 1rem;">No social accounts connected yet</p>
                    <p>Click "Connect New Platform" to get started</p>
                </div>
            `;
            return;
        }

        this.socialAccounts.forEach(account => {
            const pod = this.createSocialPod(account);
            grid.appendChild(pod);
        });
    }

    createSocialPod(account) {
        const pod = document.createElement('div');
        pod.className = `social-pod pod-${account.platform.toLowerCase()}`;

        const platformIcon = this.getPlatformIcon(account.platform);

        pod.innerHTML = `
            <div class="pod-header">
                <div class="pod-platform">
                    <div class="pod-icon">${platformIcon}</div>
                    <div>
                        <div class="pod-name">${account.platform}</div>
                    </div>
                </div>
                <div class="pod-score">${account.metrics?.engagementScore || 0}</div>
            </div>
            <div class="pod-username">@${account.username || 'username'}</div>
            <div class="pod-stats">
                <div class="pod-stat">
                    <span class="pod-stat-label">Followers</span>
                    <span class="pod-stat-value">${this.formatNumber(account.metrics?.connections || 0)}</span>
                </div>
                <div class="pod-stat">
                    <span class="pod-stat-label">Posts</span>
                    <span class="pod-stat-value">${this.formatNumber(account.metrics?.posts || 0)}</span>
                </div>
                <div class="pod-stat">
                    <span class="pod-stat-label">Pending</span>
                    <span class="pod-stat-value">${this.formatNumber(account.metrics?.pendingResponses || 0)}</span>
                </div>
                <div class="pod-stat">
                    <span class="pod-stat-label">Messages</span>
                    <span class="pod-stat-value">${this.formatNumber(account.metrics?.newMessages || 0)}</span>
                </div>
            </div>
            <div class="pod-actions">
                <button class="pod-action-btn sync" data-id="${account.id}">
                    <span>ðŸ”„</span>
                    <span>Sync</span>
                </button>
                <button class="pod-action-btn disconnect" data-id="${account.id}">
                    <span>âœ•</span>
                    <span>Disconnect</span>
                </button>
            </div>
        `;

        // Add event listeners for action buttons
        const syncBtn = pod.querySelector('.pod-action-btn.sync');
        const disconnectBtn = pod.querySelector('.pod-action-btn.disconnect');

        syncBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.syncAccount(account.id);
        });

        disconnectBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.confirmAction(
                'Disconnect Account?',
                `Are you sure you want to disconnect your ${account.platform} account (@${account.username})? This action cannot be undone.`,
                () => this.deleteAccount(account.id)
            );
        });

        return pod;
    }

    updateOverallScore() {
        if (this.socialAccounts.length === 0) {
            this.setOverallScore(0, 'No Accounts Connected');
            return;
        }

        // Calculate average score
        const totalScore = this.socialAccounts.reduce((sum, account) => {
            return sum + (account.metrics?.engagementScore || 0);
        }, 0);

        const avgScore = Math.round(totalScore / this.socialAccounts.length);

        // Calculate totals
        const totalFollowers = this.socialAccounts.reduce((sum, account) => {
            return sum + (account.metrics?.connections || 0);
        }, 0);

        const totalPosts = this.socialAccounts.reduce((sum, account) => {
            return sum + (account.metrics?.posts || 0);
        }, 0);

        // Update UI
        this.setOverallScore(avgScore, this.getScoreLabel(avgScore));

        document.getElementById('totalAccounts').textContent = this.socialAccounts.length;
        document.getElementById('totalFollowers').textContent = this.formatNumber(totalFollowers);
        document.getElementById('totalPosts').textContent = this.formatNumber(totalPosts);
    }

    setOverallScore(score, label) {
        const scoreValue = document.getElementById('overallScore');
        const scoreLabel = document.getElementById('scoreLabel');
        const scoreCircle = document.getElementById('scoreCircle');

        if (scoreValue) {
            scoreValue.textContent = score;
        }

        if (scoreLabel) {
            scoreLabel.textContent = label;
        }

        if (scoreCircle) {
            // Animate the circle (534 is the circumference for radius 85)
            const circumference = 534;
            const offset = circumference - (score / 100) * circumference;
            scoreCircle.style.strokeDashoffset = offset;
        }
    }

    getScoreLabel(score) {
        if (score >= 80) return 'Crushing It! ðŸ”¥';
        if (score >= 60) return 'Doing Well ðŸ‘';
        if (score >= 40) return 'Needs Attention âš ï¸';
        if (score >= 1) return 'Falling Behind ðŸ“‰';
        return 'Getting Started';
    }

    getPlatformIcon(platform) {
        const icons = {
            'Facebook': 'f',
            'Instagram': 'ðŸ“·',
            'Twitter': 'ðŸ¦',
            'LinkedIn': 'in',
            'TikTok': 'ðŸŽµ',
            'YouTube': 'â–¶',
            'Snapchat': 'ðŸ‘»'
        };
        return icons[platform] || 'ðŸ“±';
    }

    formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        }
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    }

    // ===== MODAL MANAGEMENT =====
    populateModal() {
        const connectedPlatforms = document.getElementById('connectedPlatforms');
        const availablePlatforms = document.getElementById('availablePlatforms');
        const connectedSection = document.getElementById('connectedSection');

        // Get connected platform names
        const connectedNames = this.socialAccounts.map(acc => acc.platform);

        // Populate connected platforms
        if (connectedNames.length > 0) {
            connectedSection.style.display = 'block';
            connectedPlatforms.innerHTML = '';

            this.socialAccounts.forEach(account => {
                const item = this.createConnectedPlatformItem(account);
                connectedPlatforms.appendChild(item);
            });
        } else {
            connectedSection.style.display = 'none';
        }

        // Populate available platforms
        availablePlatforms.innerHTML = '';
        this.allPlatforms.forEach(platform => {
            const isConnected = connectedNames.includes(platform);
            const btn = this.createPlatformButton(platform, isConnected);
            availablePlatforms.appendChild(btn);
        });
    }

    createConnectedPlatformItem(account) {
        const div = document.createElement('div');
        div.className = `connected-platform-item platform-${account.platform.toLowerCase()}`;

        const platformIcon = this.getPlatformIcon(account.platform);

        div.innerHTML = `
            <div class="platform-item-left">
                <div class="platform-item-icon">${platformIcon}</div>
                <div class="platform-item-info">
                    <div class="platform-item-name">${account.platform}</div>
                    <div class="platform-item-username">@${account.username || 'username'}</div>
                    <div class="platform-item-status">
                        <span class="status-dot"></span>
                        <span>Connected</span>
                    </div>
                </div>
            </div>
            <div class="platform-item-actions">
                <button class="icon-btn sync-btn" data-id="${account.id}" title="Sync">ðŸ”„</button>
                <button class="icon-btn disconnect-btn" data-id="${account.id}" title="Disconnect">âœ•</button>
            </div>
        `;

        // Add event listeners
        const syncBtn = div.querySelector('.sync-btn');
        const disconnectBtn = div.querySelector('.disconnect-btn');

        syncBtn.addEventListener('click', () => {
            this.syncAccount(account.id);
        });

        disconnectBtn.addEventListener('click', () => {
            this.confirmAction(
                'Disconnect Account?',
                `Are you sure you want to disconnect your ${account.platform} account (@${account.username})?`,
                () => {
                    this.deleteAccount(account.id);
                    this.closeModal();
                }
            );
        });

        return div;
    }

    createPlatformButton(platform, isConnected) {
        const button = document.createElement('button');
        button.className = `platform-btn ${isConnected ? 'connected' : 'available'}`;
        button.dataset.platform = platform.toLowerCase();

        const iconClass = `${platform.toLowerCase()}-icon`;

        button.innerHTML = `
            <div class="platform-icon ${iconClass}"></div>
            <span>${platform}</span>
            ${isConnected ? '<div class="platform-status-badge">âœ“</div>' : ''}
        `;

        if (!isConnected) {
            button.addEventListener('click', () => {
                this.handlePlatformConnect(platform);
            });
        }

        return button;
    }

    handlePlatformConnect(platform) {
        this.closeModal();
        this.connectSocialAccount(platform);
    }

    // ===== CONFIRMATION MODAL =====
    confirmAction(title, message, callback) {
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');

        titleEl.textContent = title;
        messageEl.textContent = message;

        this.confirmCallback = callback;
        modal.classList.add('active');
    }

    closeConfirmModal() {
        const modal = document.getElementById('confirmModal');
        modal.classList.remove('active');
        this.confirmCallback = null;
    }

    executeConfirm() {
        if (this.confirmCallback) {
            this.confirmCallback();
        }
        this.closeConfirmModal();
    }

    // ===== DEMO DATA =====
    loadDemoData() {
        this.socialAccounts = [
            {
                id: 'demo-1',
                platform: 'Facebook',
                username: 'yourpage',
                metrics: {
                    engagementScore: 85,
                    connections: 12500,
                    posts: 342,
                    pendingResponses: 12,
                    newMessages: 24
                }
            },
            {
                id: 'demo-2',
                platform: 'Instagram',
                username: 'yourhandle',
                metrics: {
                    engagementScore: 92,
                    connections: 28300,
                    posts: 567,
                    pendingResponses: 8,
                    newMessages: 45
                }
            },
            {
                id: 'demo-3',
                platform: 'Twitter',
                username: 'yourtwitter',
                metrics: {
                    engagementScore: 78,
                    connections: 8900,
                    posts: 1243,
                    pendingResponses: 34,
                    newMessages: 67
                }
            },
            {
                id: 'demo-4',
                platform: 'LinkedIn',
                username: 'yourprofile',
                metrics: {
                    engagementScore: 88,
                    connections: 3450,
                    posts: 156,
                    pendingResponses: 5,
                    newMessages: 18
                }
            }
        ];

        this.currentUser = {
            name: 'Demo User',
            email: 'demo@cliq24.app'
        };

        this.updateUserUI(this.currentUser);
        this.renderSocialPods();
        this.updateOverallScore();
    }

    // ===== EVENT LISTENERS =====
    setupEventListeners() {
        // Add account button
        const addBtn = document.getElementById('addAccountBtn');
        if (addBtn) {
            addBtn.addEventListener('click', () => this.openModal());
        }

        // Modal close button
        const closeBtn = document.getElementById('modalClose');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.closeModal());
        }

        // Modal background click
        const modal = document.getElementById('addAccountModal');
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.closeModal();
                }
            });
        }

        // Confirm modal buttons
        const confirmClose = document.getElementById('confirmModalClose');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmOk = document.getElementById('confirmOk');
        const confirmModal = document.getElementById('confirmModal');

        if (confirmClose) {
            confirmClose.addEventListener('click', () => this.closeConfirmModal());
        }

        if (confirmCancel) {
            confirmCancel.addEventListener('click', () => this.closeConfirmModal());
        }

        if (confirmOk) {
            confirmOk.addEventListener('click', () => this.executeConfirm());
        }

        if (confirmModal) {
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    this.closeConfirmModal();
                }
            });
        }
    }

    openModal() {
        this.populateModal();
        const modal = document.getElementById('addAccountModal');
        if (modal) {
            modal.classList.add('active');
        }
    }

    closeModal() {
        const modal = document.getElementById('addAccountModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // ===== AUTO-SYNC =====
    startAutoSync() {
        // Sync every 5 minutes
        setInterval(() => {
            if (this.jwtToken) {
                this.loadSocialAccounts();
            }
        }, 5 * 60 * 1000);
    }

    // ===== NOTIFICATIONS =====
    showSuccess(message) {
        this.showNotification(message, 'success');
    }

    showError(message) {
        this.showNotification(message, 'error');
    }

    showInfo(message) {
        this.showNotification(message, 'info');
    }

    showNotification(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);

        // Create toast
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: ${type === 'error' ? '#ff006e' : type === 'success' ? '#00ffcc' : '#00d4ff'};
            color: #0a0a0f;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    showLoginPrompt() {
        const loginUrl = `${this.apiBaseUrl}/auth/google`;

        // For demo purposes, load demo data
        this.loadDemoData();

        // Show info about demo mode
        setTimeout(() => {
            this.showInfo('Running in demo mode. Click brand logo to login.');
        }, 1000);

        // Make header clickable to login
        const brand = document.querySelector('.brand');
        if (brand) {
            brand.style.cursor = 'pointer';
            brand.addEventListener('click', () => {
                window.location.href = loginUrl;
            });
        }
    }

    handleUnauthorized() {
        this.clearJWTFromStorage();
        this.showError('Session expired. Please login again.');
        setTimeout(() => {
            window.location.href = `${this.apiBaseUrl}/auth/google`;
        }, 2000);
    }

    // ===== ADD SVG GRADIENT =====
    addSVGGradient() {
        const heroScore = document.querySelector('.hero-score-container');
        if (!heroScore) return;

        // Gradient is now in HTML, but keep this for compatibility
    }
}

// ===== ANIMATION STYLES =====
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// ===== INITIALIZE APP =====
document.addEventListener('DOMContentLoaded', () => {
    window.cliq24App = new Cliq24Dashboard();
});

// ===== HANDLE OAUTH CALLBACK =====
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');
if (token) {
    localStorage.setItem('cliq24_jwt', token);
    window.history.replaceState({}, document.title, window.location.pathname);
    window.location.reload();
}
